<!DOCTYPE html>
<html  dir="ltr" lang="en" data-theme=""><head>
    <title> z64me | Cylindrical billboarding woes </title>

    
    <meta charset="utf-8"><meta name="generator" content="Hugo 0.84.0" /><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
    <meta name="description" content="Hoot hoot! ðŸ¦‰">
    
    
    
    <link rel="stylesheet"
        href="/css/main.min.48dede57393e8417d7ed1da70ed8e9d6ec460460fc94f6b0d1e3b7f689fb1cc1.css"
        integrity="sha256-SN7eVzk&#43;hBfX7R2nDtjp1uxGBGD8lPaw0eO39on7HME="
        crossorigin="anonymous"
        type="text/css">
    
    
    <link rel="stylesheet"
        href="/css/markupHighlight.min.f798cbda9aaa38f89eb38be6414bd082cfd71a6780375cbf67b6d2fb2b96491e.css"
        integrity="sha256-95jL2pqqOPies4vmQUvQgs/XGmeAN1y/Z7bS&#43;yuWSR4="
        crossorigin="anonymous"
        type="text/css">
    
    <link rel="stylesheet" 
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css" 
    integrity="sha512-+4zCK9k+qNFUR5X+cKL9EIR+ZOhtIloNl9GIKS57V1MyNsYpYcUrUeQc9vNfzsWfV28IaLL3i96P9sdNyeRssA==" 
    crossorigin="anonymous" />
    
    <link rel="shortcut icon" href="/favicons/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon" sizes="180x180" href="/favicons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicons/favicon-16x16.png">

    <link rel="canonical" href="/post/cylindrical-billboarding-woes/">

    
    
    
    
    <script type="text/javascript"
            src="/js/anatole-header.min.98b79432dfa53ecc682fb19247f797a316f8cbca9d5455c8bb22e58fc694b675.js"
            integrity="sha256-mLeUMt&#43;lPsxoL7GSR/eXoxb4y8qdVFXIuyLlj8aUtnU="
            crossorigin="anonymous"></script>


    
        
        
        <script type="text/javascript"
                src="/js/anatole-theme-switcher.min.7fd87181cdd7e8413aa64b6867bb32f3a8dc242e684fc7d5bbb9f600dbc2b6eb.js"
                integrity="sha256-f9hxgc3X6EE6pktoZ7sy86jcJC5oT8fVu7n2ANvCtus="
                crossorigin="anonymous"></script>
    
    <meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://z64.me/images/site-feature-image.png"/>

<meta name="twitter:title" content="Cylindrical billboarding woes"/>
<meta name="twitter:description" content="In this article, I explain how I hackishly added cylindrical billboarding support to OoT."/>


    

</head>
<body>
<header><div class="page-top  . ">
    <a role="button" class="navbar-burger" data-target="navMenu" aria-label="menu" aria-expanded="false">
        <span aria-hidden="true"></span>
        <span aria-hidden="true"></span>
        <span aria-hidden="true"></span>
    </a>
    <nav>
        <ul class="nav__list" id="navMenu">
            <div class="nav__links">
                
                
                    
                    <li><a 
                        href="/"
                                
                        title="">Home</a></li>
                
                    
                    <li><a 
                        href="/post/"
                                
                        title="">Posts</a></li>
                
                    
                    <li><a 
                        href="/about/"
                                
                        title="">About</a></li>
                
                
                    
                        <li><a href="/"
                            title=""></a>
                        </li>
                    
                        <li><a href="/ar/"
                            title=""></a>
                        </li>
                    
                
            </div>
            <li>
                
                <a class="theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                </a>
                
            </li>
        </ul>
    </nav>
</div>
</header>
<div class="wrapper">
    <aside><div class="sidebar . ">
    <div class="sidebar__content">
        <div class="logo-title">
            <div class="title">
                <img src="/images/profile.jpg" alt="profile picture">
                <h3 title=""><a href="/">z64me</a></h3>
                <div class="description">
                    <p>Hoot hoot! ðŸ¦‰</p>
                </div>
            </div>
        </div>
        <ul class="social-links">
            
                <li>
                    <a href="https://github.com/z64me" rel="me" aria-label="GitHub">
                        <i class="fab fa-github fa-2x" aria-hidden="true"></i>
                    </a>
                </li>
            
                <li>
                    <a href="https://www.youtube.com/c/z64me/videos" rel="me" aria-label="YouTube">
                        <i class="fab fa-youtube fa-2x" aria-hidden="true"></i>
                    </a>
                </li>
            
        </ul>
    </div><footer class="footer footer--sidebar">        
    <div class="by_farbox">
        <ul class="footer__list">
            <li class="footer__item">&copy;
                
                    2018 - 2021
                
            </li>
            
            <li class="footer__item">
                <a href="https://old.z64.me/"  target="_blank" rel="noopener noreferrer"  title="">
                    old site
                </a>
            </li>
            
            <li class="footer__item">
                <a href="/post/index.xml"  title="">
                    rss
                </a>
            </li>
            
        </ul>
    </div>
</footer>

<script type="text/javascript"
        src="/js/medium-zoom.min.83cb1dd5fea8d42d87d1e601a07faa73089ad0ef9ccfe5daf6041289ebcc4e46.js"
        integrity="sha256-g8sd1f6o1C2H0eYBoH&#43;qcwia0O&#43;cz&#43;Xa9gQSievMTkY="
        crossorigin="anonymous"></script></div>
</aside>
    <main>
        <div class="autopagerize_page_element">
            <div class="content">
    <div class="post  . ">
        <div class="post-content">
            
            <img class="post-thumbnail" src="https://old.z64.me/home/cylindrical-billboarding-woes/bay-fixed.jpg" alt="Thumbnail image">
            
            <div class="post-title">
                <h1>Cylindrical billboarding woes</h1>
                
                    <div class="info">
                        <em class="fas fa-calendar-day"></em>
                        <span class="date"> 
                                                9/1/2019
                                           </span>
                        <em class="fas fa-stopwatch"></em>
                        <span class="reading-time">3-minute read</span>
                    </div>
                
            </div>

            <p>In this article, I explain how I hackishly added cylindrical billboarding support to OoT.</p>
<p>First, some background. If you&rsquo;ve ever ported a map from Majora&rsquo;s Mask to Ocarina of Time, chances are you&rsquo;ve seen missing or misplaced map meshes.</p>
<p><img src="https://old.z64.me/home/cylindrical-billboarding-woes/observatory-broken.jpg" alt="observatory-broken">
<img src="https://old.z64.me/home/cylindrical-billboarding-woes/bay-broken.jpg" alt="bay-broken">
<img src="https://old.z64.me/home/cylindrical-billboarding-woes/town-broken.jpg" alt="town-broken"></p>
<!--<figure class="left"><img src="https://old.z64.me/home/cylindrical-billboarding-woes/observatory-broken.jpg"
         alt="observatory-broken" width="320" height="240"/>
</figure>

<figure class="left"><img src="https://old.z64.me/home/cylindrical-billboarding-woes/bay-broken.jpg"
         alt="bay-broken" width="320" height="240"/>
</figure>

<figure class="left"><img src="https://old.z64.me/home/cylindrical-billboarding-woes/town-broken.jpg"
         alt="town-broken" width="320" height="240"/>
</figure>
-->
<p>&ldquo;What causes this?&rdquo;, you might ask yourself. Let&rsquo;s inspect the display list in a hex editor and find out.</p>
<p><img src="https://old.z64.me/home/cylindrical-billboarding-woes/xvi32.png" alt="xvi32"></p>
<p>The bytes <code>DA380001 01000040</code> may catch your attention. These bytes push the matrix <code>01000040</code> onto the stack. Ocarina of Time does this all the time for billboards like Navi, bombs, the sun, and the moon, but that&rsquo;s with matrix <code>01000000</code>. What&rsquo;s so special about matrix <code>01000040</code>? Let&rsquo;s substitute one for the other and see what happens.</p>
<p><img src="https://old.z64.me/home/cylindrical-billboarding-woes/town-hack.jpg" alt="town-hack"></p>
<p>Perfect, everything works now. Case closed. Except, not really. How do these look from above?</p>
<p><img src="https://old.z64.me/home/cylindrical-billboarding-woes/town-spherical.jpg" alt="town-spherical"></p>
<p>Oh no, they are locked to face the camera from all angles! You&rsquo;ll get problems with these posts anytime the camera is looking up or down. When the camera isn&rsquo;t level, something is noticeably wrong with them.</p>
<p>It turns out that all objects using matrix <code>01000000</code> (Navi, bombs, the sun, the moon, and more) have one thing in common: they face the camera no matter what angle you view them from. We call this a <strong>spherical billboard</strong>.</p>
<p>After inspecting the behavior of matrix <code>01000040</code> in Majora&rsquo;s Mask, we conclude that all objects that use it are always upright. The objects are still forced to face the camera, but the world&rsquo;s up direction is always respected, so not on that axis. This is called a <strong>cylindrical billboard</strong>.</p>
<p>You can witness the difference for yourself outside the Astral Observatory in Majora&rsquo;s Mask. It turns out, one of the stars uses a spherical billboard and the other uses a cylindrical billboard. Perhaps the cylindrical billboard matrix was added late in the game&rsquo;s development and they forgot to update this one.</p>
<p><img src="https://old.z64.me/home/cylindrical-billboarding-woes/star-cylindrical-spherical.jpg" alt="star-cylindrical-spherical"></p>
<p>&ldquo;But Ocarina of Time does that too! What about the flame actors?&rdquo;, you may be thinking. This was very boggling, but it turns out actors that do this in OoT calculate their position relative to the camera and rotate the models so they align to the camera on all axes besides Y (up). In this sense, OoT does cylindrical billboards, but not via a global matrix. We cannot apply this hack on maps.</p>
<p>Since OoT does not create this matrix, <code>01000040</code> is junk data. This explains why the map parts that referenced it were floating around strangely.</p>
<p>Now, to write an assembly hack that will create a cylindrical billboard matrix that will be accessible in maps and objects by pushing matrix <code>01000040</code> onto the stack, like in MM. Do so without overwriting or breaking the matrix <code>01000000</code>.</p>
<p>To save you a long story detailing all the trouble it was and how it still isn&rsquo;t perfect, I&rsquo;ll just say that it&rsquo;s usable for the purposes I intended for it to be usable for.</p>
<p><img src="https://old.z64.me/home/cylindrical-billboarding-woes/observatory-fixed.jpg" alt="observatory-fixed">
<img src="https://old.z64.me/home/cylindrical-billboarding-woes/bay-fixed.jpg" alt="bay-fixed">
<img src="https://old.z64.me/home/cylindrical-billboarding-woes/town-cylindrical.jpg" alt="town-cylindrical"></p>
<p>As an additional test, I modeled a lamppost and embedded it into Kokiri Forest&rsquo;s geometry.</p>
<p><img src="https://old.z64.me/home/cylindrical-billboarding-woes/light.jpg" alt="light"></p>
<p>The lower right image is a screenshot from Killgore52 (aka E-Gor) showing that the assembly and mesh are hardware compatible. Thanks man!</p>
<p>Finally, <a href="https://old.z64.me/home/cylindrical-billboarding-woes/cylindrical-matrix.zip">here&rsquo;s a zip</a> containing the modified <code>code</code>, <code>spot04_room_0*</code>, and <code>spot04_scene</code>. Do a file comparison between this <code>code</code> and the original to find what has changed. Some notes are also embedded within. If you improve upon it (it needs it), please share your fixes so everyone can use cylindrical billboards that have been refined as much as possible.</p>
<p>* Because content was added to Kokiri Forest, its size increased, so keep that in mind when putting it in the rom for testing!</p></div>
        <div class="post-footer">
            <div class="info">
                
                <span class="separator"><a class="tag" href="/tags/mods/">mods</a><a class="tag" href="/tags/fun/">fun</a><a class="tag" href="/tags/articles/">articles</a></span>
            </div>
        </div>

        
    </div>


            </div>
        </div>
    </main>
</div><footer class="footer footer--base">        
    <div class="by_farbox">
        <ul class="footer__list">
            <li class="footer__item">&copy;
                
                    2018 - 2021
                
            </li>
            
            <li class="footer__item">
                <a href="https://old.z64.me/"  target="_blank" rel="noopener noreferrer"  title="">
                    old site
                </a>
            </li>
            
            <li class="footer__item">
                <a href="/post/index.xml"  title="">
                    rss
                </a>
            </li>
            
        </ul>
    </div>
</footer>

<script type="text/javascript"
        src="/js/medium-zoom.min.83cb1dd5fea8d42d87d1e601a07faa73089ad0ef9ccfe5daf6041289ebcc4e46.js"
        integrity="sha256-g8sd1f6o1C2H0eYBoH&#43;qcwia0O&#43;cz&#43;Xa9gQSievMTkY="
        crossorigin="anonymous"></script></body>

</html>
