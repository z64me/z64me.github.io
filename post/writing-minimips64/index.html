<!DOCTYPE html>
<html  dir="ltr" lang="en" data-theme="light"><head>
    <title> z64me | Writing a tiny MIPS assembler and disassembler in C </title>

    
    <meta charset="utf-8"><meta name="generator" content="Hugo 0.84.0" /><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
    <meta name="description" content="Hoot hoot! ðŸ¦‰">
    
    
    
    <link rel="stylesheet"
        href="/css/main.min.a64b503bd01d7d777f851f0e4b751dcd433d000a2187b9494c48797538337163.css"
        integrity="sha256-pktQO9AdfXd/hR8OS3UdzUM9AAohh7lJTEh5dTgzcWM="
        crossorigin="anonymous"
        type="text/css">
    
    
    <link rel="stylesheet"
        href="/css/markupHighlight.min.bc108ac4d429f5e06afa75cfccb6585578f5198a03d669c1bd24b26e4a2895b7.css"
        integrity="sha256-vBCKxNQp9eBq&#43;nXPzLZYVXj1GYoD1mnBvSSybkoolbc="
        crossorigin="anonymous"
        type="text/css">
    
    <link rel="stylesheet" 
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css" 
    integrity="sha512-+4zCK9k+qNFUR5X+cKL9EIR+ZOhtIloNl9GIKS57V1MyNsYpYcUrUeQc9vNfzsWfV28IaLL3i96P9sdNyeRssA==" 
    crossorigin="anonymous" />
    
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">

    <link rel="canonical" href="/post/writing-minimips64/">

    
    
    
    
    <script type="text/javascript"
            src="/js/anatole-header.min.98b79432dfa53ecc682fb19247f797a316f8cbca9d5455c8bb22e58fc694b675.js"
            integrity="sha256-mLeUMt&#43;lPsxoL7GSR/eXoxb4y8qdVFXIuyLlj8aUtnU="
            crossorigin="anonymous"></script>


    
    <meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://z64.me/images/site-feature-image.png"/>

<meta name="twitter:title" content="Writing a tiny MIPS assembler and disassembler in C"/>
<meta name="twitter:description" content="We are able to do most of our Nintendo 64 development in C nowadays. But things weren&rsquo;t always like that! Long ago, legendary hackers did it all in handwritten assembly. Join me as I write a minimalistic MIPS assembler/disassembler and show you how to compile a rudimentary hack using it."/>


    

</head>
<body>
<header><div class="page-top  . ">
    <a role="button" class="navbar-burger" data-target="navMenu" aria-label="menu" aria-expanded="false">
        <span aria-hidden="true"></span>
        <span aria-hidden="true"></span>
        <span aria-hidden="true"></span>
    </a>
    <nav>
        <ul class="nav__list" id="navMenu">
            <div class="nav__links">
                
                
                    
                    <li><a 
                        href="/"
                                
                        title="">Home</a></li>
                
                    
                    <li><a 
                        href="/post/"
                                
                        title="">Posts</a></li>
                
                    
                    <li><a 
                        href="/about/"
                                
                        title="">About</a></li>
                
                
                    
                        <li><a href="/"
                            title=""></a>
                        </li>
                    
                        <li><a href="/ar/"
                            title=""></a>
                        </li>
                    
                
            </div>
            <li>
                
            </li>
        </ul>
    </nav>
</div>
</header>
<div class="wrapper">
    <aside><div class="sidebar . ">
    <div class="sidebar__content">
        <div class="logo-title">
            <div class="title">
                <img src="/images/profile.jpg" alt="profile picture">
                <h3 title=""><a href="/">z64me</a></h3>
                <div class="description">
                    <p>Hoot hoot! ðŸ¦‰</p>
                </div>
            </div>
        </div>
        <ul class="social-links">
            
                <li>
                    <a href="https://github.com/z64me" rel="me" aria-label="GitHub">
                        <i class="fab fa-github fa-2x" aria-hidden="true"></i>
                    </a>
                </li>
            
                <li>
                    <a href="https://www.youtube.com/c/z64me/videos" rel="me" aria-label="YouTube">
                        <i class="fab fa-youtube fa-2x" aria-hidden="true"></i>
                    </a>
                </li>
            
        </ul>
    </div><footer class="footer footer--sidebar">        
    <div class="by_farbox">
        <ul class="footer__list">
            <li class="footer__item">&copy;
                
                    2018 - 2021
                
            </li>
            
            <li class="footer__item">
                <a href="https://old.z64.me/"  target="_blank" rel="noopener noreferrer"  title="">
                    old site
                </a>
            </li>
            
            <li class="footer__item">
                <a href="/post/index.xml"  title="">
                    rss
                </a>
            </li>
            
        </ul>
    </div>
</footer>

<script type="text/javascript"
        src="/js/medium-zoom.min.83cb1dd5fea8d42d87d1e601a07faa73089ad0ef9ccfe5daf6041289ebcc4e46.js"
        integrity="sha256-g8sd1f6o1C2H0eYBoH&#43;qcwia0O&#43;cz&#43;Xa9gQSievMTkY="
        crossorigin="anonymous"></script></div>
</aside>
    <main>
        <div class="autopagerize_page_element">
            <div class="content">
    <div class="post  . ">
        <div class="post-content">
            
            <img class="post-thumbnail" src="/thumbnails/writing-minimips64.png" alt="Thumbnail image">
            
            <div class="post-title">
                <h1>Writing a tiny MIPS assembler and disassembler in C</h1>
                
                    <div class="info">
                        <em class="fas fa-calendar-day"></em>
                        <span class="date"> 
                                                30/7/2021
                                           </span>
                        <em class="fas fa-stopwatch"></em>
                        <span class="reading-time">10-minute read</span>
                    </div>
                
            </div>

            <p>We are able to do most of our Nintendo 64 development in C nowadays. But things weren&rsquo;t always like that! Long ago, legendary hackers did it all in handwritten assembly. Join me as I write a minimalistic MIPS assembler/disassembler and show you how to compile a rudimentary hack using it.</p>
<h2 id="so-what-exactly-is-an-assembler">So, what exactly is an assembler?</h2>
<p>Modern processors are like ancient calculators: only faster and more compact. They contain everything necessary to perform basic arithmetic and logic. All we have to do is provide instructions for it to follow.</p>
<p>These instructions are comprised of zeroes and ones, creating what&rsquo;s commonly called &ldquo;bytecode&rdquo;. Our human brains have a better time interpreting letters and numbers, so assembly language acts as the intermediary. It gives us a way to write the instructions in a way we understand.</p>
<p>The assembler program&rsquo;s job is to read the assembly language and produce bytecode the computer can understand. As you might expect from the name, a disassembler does the opposite. My program will do both.</p>
<p><img src="/images/writing-minimips-1.png" alt="image"></p>
<h2 id="mips">MIPS</h2>
<p>In the world of computers, there is no &ldquo;one size fits all&rdquo;. There are so many different types of processors, and they don&rsquo;t all use the same instruction set. The instruction set the Nintendo 64 (the target platform) uses is called MIPS R4300i.</p>
<h2 id="instruction-encoding">Instruction encoding</h2>
<p>Before implementing MIPS, we must understand its instruction encoding. Thankfully, Anarko compiled <a href="https://www.romhacking.net/documents/649/">this comprehensive documentation</a>. It is an invaluable resource. Check out this snippet from it:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">-----------------------------------------------------------------
| BEQ       | Branch on EQual                                   |
|-----------|---------------------------------------------------|
|000100 (4) |   rs    |   rt    |            offset             |
------6----------5---------5-------------------16----------------
 Format:  BEQ rs, rt, offset
 Purpose: To compare GPRs then do a PC-relative conditional branch.
 Comment: BEQ rs, r0, offset is equal to a BEQZ rs, offset
          BEQ r0, r0, offset is equal to a B offset
 Descrip: branch if rs = rt
</code></pre></div><p>To keep my source code simple, I compared every instruction&rsquo;s encoding scheme and decided on a common structure I could use to represent them all:</p>
<div class="highlight"><pre class="chroma"><code class="language-c" data-lang="c"><span class="k">struct</span> <span class="n">pack</span>
<span class="p">{</span>
   <span class="kt">int</span>   <span class="n">is_reg</span><span class="p">;</span> <span class="cm">/* is a register value                */</span>
   <span class="kt">int</span>   <span class="n">is_fp</span><span class="p">;</span>  <span class="cm">/* is a floating-point register       */</span>
   <span class="kt">int</span>   <span class="n">is_v</span><span class="p">;</span>   <span class="cm">/* use value v below for packing      */</span>
   <span class="kt">int</span>   <span class="n">v</span><span class="p">;</span>      <span class="cm">/* value to use if (is_v)             */</span>
   <span class="kt">int</span>   <span class="n">shift</span><span class="p">;</span>  <span class="cm">/* bit shift by (negative means left) */</span>
   <span class="kt">int</span>   <span class="n">and</span><span class="p">;</span>    <span class="cm">/* bitwise &amp; by (0 = last entry)      */</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">inst</span>
<span class="p">{</span>
   <span class="k">const</span> <span class="kt">char</span>    <span class="o">*</span><span class="n">name</span><span class="p">;</span>
   <span class="k">struct</span> <span class="n">pack</span>    <span class="n">pack</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
   <span class="kt">int</span>            <span class="n">is_branch</span><span class="p">;</span>
   <span class="kt">unsigned</span>       <span class="n">code</span><span class="p">;</span>
   <span class="kt">unsigned</span>       <span class="n">mask</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div><p>Because going through and deriving values for these one-by-one would be a pain (there are nearly three-hundred unique instructions!), I quickly wrote a program to parse the documentation and automate this task. They all go into an array:</p>
<div class="highlight"><pre class="chroma"><code class="language-c" data-lang="c"><span class="cm">/* ... */</span>
<span class="p">,</span> <span class="p">{</span> <span class="s">&#34;xori&#34;</span><span class="p">,</span> <span class="p">{</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">16</span><span class="p">,</span> <span class="mi">31</span><span class="p">},</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">21</span><span class="p">,</span> <span class="mi">31</span><span class="p">},</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">65535</span><span class="p">},</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="o">-</span><span class="mi">26</span><span class="p">,</span> <span class="mi">63</span><span class="p">}},</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">939524096</span><span class="p">,</span> <span class="o">-</span><span class="mi">67108864</span> <span class="p">}</span>
<span class="p">,</span> <span class="p">{</span> <span class="s">&#34;beq&#34;</span><span class="p">,</span> <span class="p">{</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">21</span><span class="p">,</span> <span class="mi">31</span><span class="p">},</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">16</span><span class="p">,</span> <span class="mi">31</span><span class="p">},</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">65535</span><span class="p">},</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="o">-</span><span class="mi">26</span><span class="p">,</span> <span class="mi">63</span><span class="p">}},</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">268435456</span><span class="p">,</span> <span class="o">-</span><span class="mi">67108864</span> <span class="p">}</span>
<span class="p">,</span> <span class="p">{</span> <span class="s">&#34;beql&#34;</span><span class="p">,</span> <span class="p">{</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">21</span><span class="p">,</span> <span class="mi">31</span><span class="p">},</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">16</span><span class="p">,</span> <span class="mi">31</span><span class="p">},</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">65535</span><span class="p">},</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="o">-</span><span class="mi">26</span><span class="p">,</span> <span class="mi">63</span><span class="p">}},</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1342177280</span><span class="p">,</span> <span class="o">-</span><span class="mi">67108864</span> <span class="p">}</span>
<span class="p">,</span> <span class="p">{</span> <span class="s">&#34;bgez&#34;</span><span class="p">,</span> <span class="p">{</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">21</span><span class="p">,</span> <span class="mi">31</span><span class="p">},</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">65535</span><span class="p">},</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">26</span><span class="p">,</span> <span class="mi">63</span><span class="p">},</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">16</span><span class="p">,</span> <span class="mi">31</span><span class="p">}},</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">67174400</span><span class="p">,</span> <span class="o">-</span><span class="mi">65077248</span> <span class="p">}</span>
<span class="p">,</span> <span class="p">{</span> <span class="s">&#34;bgezal&#34;</span><span class="p">,</span> <span class="p">{</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">21</span><span class="p">,</span> <span class="mi">31</span><span class="p">},</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">65535</span><span class="p">},</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">26</span><span class="p">,</span> <span class="mi">63</span><span class="p">},</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="o">-</span><span class="mi">16</span><span class="p">,</span> <span class="mi">31</span><span class="p">}},</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">68222976</span><span class="p">,</span> <span class="o">-</span><span class="mi">65077248</span> <span class="p">}</span>
<span class="cm">/* ... */</span>
</code></pre></div><p>This table has an entry for every instruction, and contains all the information necessary for packing and unpacking each.</p>
<h2 id="disassembling">Disassembling</h2>
<p>The first thing I did after constructing my table was implement disassembling. It is smartest to add disassembling first because all you have to do is compare the output against that of a known-working disassembler such as LemASM.</p>
<p>Because I use a common structure to describe every instruction, I don&rsquo;t have to write different functions for each, meaning very little code is required for disassembly.</p>
<div class="highlight"><pre class="chroma"><code class="language-c" data-lang="c"><span class="k">const</span> <span class="k">struct</span> <span class="n">inst</span> <span class="o">*</span><span class="nf">findinstFromBin</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
   <span class="k">const</span> <span class="k">struct</span> <span class="n">inst</span> <span class="o">*</span><span class="n">i</span><span class="p">;</span>
   <span class="k">const</span> <span class="k">struct</span> <span class="n">inst</span> <span class="o">*</span><span class="n">end</span> <span class="o">=</span> <span class="n">inst</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">inst</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">inst</span><span class="p">);</span>
   
   <span class="cm">/* search instruction lut for matching name */</span>
   <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">inst</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
      <span class="cm">/* code mask matches */</span>
      <span class="k">if</span> <span class="p">((</span><span class="n">v</span> <span class="o">&amp;</span> <span class="n">i</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">)</span> <span class="o">==</span> <span class="n">i</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">)</span>
         <span class="k">return</span> <span class="n">i</span><span class="p">;</span>
   
   <span class="cm">/* no match found */</span>
   <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">unpack</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">v</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pack</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">shift</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
      <span class="n">v</span> <span class="o">&gt;&gt;=</span> <span class="o">-</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">shift</span><span class="p">;</span>
   <span class="k">else</span>
      <span class="n">v</span> <span class="o">&lt;&lt;=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">shift</span><span class="p">;</span>
   <span class="k">return</span> <span class="n">v</span> <span class="o">&amp;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">and</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* disassemble an instruction */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">dasm</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
   <span class="k">const</span> <span class="k">struct</span> <span class="n">inst</span> <span class="o">*</span><span class="n">i</span><span class="p">;</span>
   <span class="k">const</span> <span class="k">struct</span> <span class="n">pack</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
   <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">notation_imm</span> <span class="o">=</span> <span class="s">&#34;0x%04x&#34;</span><span class="p">;</span>
   <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">notation_fp</span> <span class="o">=</span> <span class="s">&#34;f%d&#34;</span><span class="p">;</span>
   <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">notation</span> <span class="o">=</span> <span class="s">&#34;%s&#34;</span><span class="p">;</span>
   
   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">op</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">&#34;nop</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
   
   <span class="cm">/* no match found */</span>
   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">findinstFromBin</span><span class="p">(</span><span class="n">op</span><span class="p">)))</span>
      <span class="n">die</span><span class="p">(</span><span class="s">&#34;invalid instruction %08X&#34;</span><span class="p">,</span> <span class="n">op</span><span class="p">);</span>
   
   <span class="cm">/* unpack instruction */</span>
   <span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">&#34;%-12s&#34;</span><span class="p">,</span> <span class="n">i</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
   <span class="k">for</span> <span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">i</span><span class="o">-&gt;</span><span class="n">pack</span><span class="p">;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">and</span><span class="p">;</span> <span class="o">++</span><span class="n">p</span><span class="p">)</span>
   <span class="p">{</span>
      <span class="cm">/* is register */</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">is_reg</span><span class="p">)</span>
      <span class="p">{</span>
         <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">is_fp</span><span class="p">)</span>
            <span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="n">notation_fp</span><span class="p">,</span> <span class="n">unpack</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">p</span><span class="p">));</span>
         <span class="k">else</span>
            <span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="n">notation</span><span class="p">,</span> <span class="n">regName</span><span class="p">(</span><span class="n">unpack</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">p</span><span class="p">)));</span>
         <span class="n">notation</span> <span class="o">=</span> <span class="s">&#34;, %s&#34;</span><span class="p">;</span>
         <span class="n">notation_imm</span> <span class="o">=</span> <span class="s">&#34;, 0x%04x&#34;</span><span class="p">;</span>
         <span class="n">notation_fp</span> <span class="o">=</span> <span class="s">&#34;, f%d&#34;</span><span class="p">;</span>
      <span class="p">}</span>
      
      <span class="cm">/* is immediate */</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">is_v</span><span class="p">)</span>
      <span class="p">{</span>
         <span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="n">notation_imm</span><span class="p">,</span> <span class="n">unpack</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">p</span><span class="p">));</span>
         <span class="n">notation</span> <span class="o">=</span> <span class="s">&#34;(%s)&#34;</span><span class="p">;</span>
      <span class="p">}</span>
   <span class="p">}</span>
   <span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">&#34;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
   <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div><p>Disassembling a 32-bit instruction is as simple as calling <code>dasm(0x03E00008);</code>.</p>
<p>Here is some sample output from running the command <code>minimips64 --disassemble --address 0x76150 --prefix --hex --jrra &quot;code-10u.bin&quot;</code>. You can see the address of and hexadecimal notation for instructions listed to the left of each. The <code>--jrra</code> argument tells it to stop when it reaches the <code>jr ra</code> at the end of the function.</p>
<div class="highlight"><pre class="chroma"><code class="language-c" data-lang="c"><span class="cm">/*00076150, 00004825*/</span>   <span class="n">or</span>          <span class="n">t1</span><span class="p">,</span> <span class="n">r0</span><span class="p">,</span> <span class="n">r0</span>
<span class="cm">/*00076154, 8C6802C0*/</span>   <span class="n">lw</span>          <span class="n">t0</span><span class="p">,</span> <span class="mh">0x02c0</span><span class="p">(</span><span class="n">v1</span><span class="p">)</span>
<span class="cm">/*00076158, 3C0CDB06*/</span>   <span class="n">lui</span>         <span class="n">t4</span><span class="p">,</span> <span class="mh">0xdb06</span>
<span class="cm">/*0007615C, 358C0030*/</span>   <span class="n">ori</span>         <span class="n">t4</span><span class="p">,</span> <span class="n">t4</span><span class="p">,</span> <span class="mh">0x0030</span>
<span class="cm">/*00076160, 250B0008*/</span>   <span class="n">addiu</span>       <span class="n">t3</span><span class="p">,</span> <span class="n">t0</span><span class="p">,</span> <span class="mh">0x0008</span>
<span class="cm">/*00076164, AC6B02C0*/</span>   <span class="n">sw</span>          <span class="n">t3</span><span class="p">,</span> <span class="mh">0x02c0</span><span class="p">(</span><span class="n">v1</span><span class="p">)</span>
<span class="cm">/*00076168, AD0C0000*/</span>   <span class="n">sw</span>          <span class="n">t4</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">(</span><span class="n">t0</span><span class="p">)</span>
<span class="cm">/*0007616C, 8FAD0050*/</span>   <span class="n">lw</span>          <span class="n">t5</span><span class="p">,</span> <span class="mh">0x0050</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="cm">/*00076170, 240B0020*/</span>   <span class="n">addiu</span>       <span class="n">t3</span><span class="p">,</span> <span class="n">r0</span><span class="p">,</span> <span class="mh">0x0020</span>
<span class="cm">/*00076174, 240E0040*/</span>   <span class="n">addiu</span>       <span class="n">t6</span><span class="p">,</span> <span class="n">r0</span><span class="p">,</span> <span class="mh">0x0040</span>
<span class="cm">/*00076178, 8DA40000*/</span>   <span class="n">lw</span>          <span class="n">a0</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">(</span><span class="n">t5</span><span class="p">)</span>
<span class="cm">/*0007617C, 24180020*/</span>   <span class="n">addiu</span>       <span class="n">t8</span><span class="p">,</span> <span class="n">r0</span><span class="p">,</span> <span class="mh">0x0020</span>
<span class="cm">/*00076180, 240F0001*/</span>   <span class="n">addiu</span>       <span class="n">t7</span><span class="p">,</span> <span class="n">r0</span><span class="p">,</span> <span class="mh">0x0001</span>
<span class="cm">/*00076184, 24190040*/</span>   <span class="n">addiu</span>       <span class="n">t9</span><span class="p">,</span> <span class="n">r0</span><span class="p">,</span> <span class="mh">0x0040</span>
<span class="cm">/*00076188, AFB90024*/</span>   <span class="n">sw</span>          <span class="n">t9</span><span class="p">,</span> <span class="mh">0x0024</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="cm">/*0007618C, AFAF0018*/</span>   <span class="n">sw</span>          <span class="n">t7</span><span class="p">,</span> <span class="mh">0x0018</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="cm">/*00076190, AFB80014*/</span>   <span class="n">sw</span>          <span class="n">t8</span><span class="p">,</span> <span class="mh">0x0014</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="cm">/*00076194, AFA30044*/</span>   <span class="n">sw</span>          <span class="n">v1</span><span class="p">,</span> <span class="mh">0x0044</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="cm">/*00076198, AFAB0028*/</span>   <span class="n">sw</span>          <span class="n">t3</span><span class="p">,</span> <span class="mh">0x0028</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="cm">/*0007619C, AFA90020*/</span>   <span class="n">sw</span>          <span class="n">t1</span><span class="p">,</span> <span class="mh">0x0020</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="cm">/*000761A0, AFA0001C*/</span>   <span class="n">sw</span>          <span class="n">r0</span><span class="p">,</span> <span class="mh">0x001c</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="cm">/*000761A4, AFAE0010*/</span>   <span class="n">sw</span>          <span class="n">t6</span><span class="p">,</span> <span class="mh">0x0010</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="cm">/*000761A8, 00002825*/</span>   <span class="n">or</span>          <span class="n">a1</span><span class="p">,</span> <span class="n">r0</span><span class="p">,</span> <span class="n">r0</span>
<span class="cm">/*000761AC, 00003025*/</span>   <span class="n">or</span>          <span class="n">a2</span><span class="p">,</span> <span class="n">r0</span><span class="p">,</span> <span class="n">r0</span>
<span class="cm">/*000761B0, 00003825*/</span>   <span class="n">or</span>          <span class="n">a3</span><span class="p">,</span> <span class="n">r0</span><span class="p">,</span> <span class="n">r0</span>
<span class="cm">/*000761B4, 0C01FAE1*/</span>   <span class="n">jal</span>         <span class="mh">0x7eb84</span>
<span class="cm">/*000761B8, AFA8003C*/</span>   <span class="n">sw</span>          <span class="n">t0</span><span class="p">,</span> <span class="mh">0x003c</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="cm">/*000761BC, 8FAA003C*/</span>   <span class="n">lw</span>          <span class="n">t2</span><span class="p">,</span> <span class="mh">0x003c</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="cm">/*000761C0, 8FA30044*/</span>   <span class="n">lw</span>          <span class="n">v1</span><span class="p">,</span> <span class="mh">0x0044</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="cm">/*000761C4, 3C18FB00*/</span>   <span class="n">lui</span>         <span class="n">t8</span><span class="p">,</span> <span class="mh">0xfb00</span>
<span class="cm">/*000761C8, AD420004*/</span>   <span class="n">sw</span>          <span class="n">v0</span><span class="p">,</span> <span class="mh">0x0004</span><span class="p">(</span><span class="n">t2</span><span class="p">)</span>
<span class="cm">/*000761CC, 8C6802C0*/</span>   <span class="n">lw</span>          <span class="n">t0</span><span class="p">,</span> <span class="mh">0x02c0</span><span class="p">(</span><span class="n">v1</span><span class="p">)</span>
<span class="cm">/*000761D0, 3C0DE700*/</span>   <span class="n">lui</span>         <span class="n">t5</span><span class="p">,</span> <span class="mh">0xe700</span>
<span class="cm">/*000761D4, 3C0BDB06*/</span>   <span class="n">lui</span>         <span class="n">t3</span><span class="p">,</span> <span class="mh">0xdb06</span>
<span class="cm">/*000761D8, 250C0008*/</span>   <span class="n">addiu</span>       <span class="n">t4</span><span class="p">,</span> <span class="n">t0</span><span class="p">,</span> <span class="mh">0x0008</span>
<span class="cm">/*000761DC, AC6C02C0*/</span>   <span class="n">sw</span>          <span class="n">t4</span><span class="p">,</span> <span class="mh">0x02c0</span><span class="p">(</span><span class="n">v1</span><span class="p">)</span>
<span class="cm">/*000761E0, AD000004*/</span>   <span class="n">sw</span>          <span class="n">r0</span><span class="p">,</span> <span class="mh">0x0004</span><span class="p">(</span><span class="n">t0</span><span class="p">)</span>
<span class="cm">/*000761E4, AD0D0000*/</span>   <span class="n">sw</span>          <span class="n">t5</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">(</span><span class="n">t0</span><span class="p">)</span>
<span class="cm">/*000761E8, 8C6802C0*/</span>   <span class="n">lw</span>          <span class="n">t0</span><span class="p">,</span> <span class="mh">0x02c0</span><span class="p">(</span><span class="n">v1</span><span class="p">)</span>
<span class="cm">/*000761EC, 3C0F8080*/</span>   <span class="n">lui</span>         <span class="n">t7</span><span class="p">,</span> <span class="mh">0x8080</span>
<span class="cm">/*000761F0, 35EF8080*/</span>   <span class="n">ori</span>         <span class="n">t7</span><span class="p">,</span> <span class="n">t7</span><span class="p">,</span> <span class="mh">0x8080</span>
<span class="cm">/*000761F4, 250E0008*/</span>   <span class="n">addiu</span>       <span class="n">t6</span><span class="p">,</span> <span class="n">t0</span><span class="p">,</span> <span class="mh">0x0008</span>
<span class="cm">/*000761F8, AC6E02C0*/</span>   <span class="n">sw</span>          <span class="n">t6</span><span class="p">,</span> <span class="mh">0x02c0</span><span class="p">(</span><span class="n">v1</span><span class="p">)</span>
<span class="cm">/*000761FC, AD0F0004*/</span>   <span class="n">sw</span>          <span class="n">t7</span><span class="p">,</span> <span class="mh">0x0004</span><span class="p">(</span><span class="n">t0</span><span class="p">)</span>
<span class="cm">/*00076200, AD180000*/</span>   <span class="n">sw</span>          <span class="n">t8</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">(</span><span class="n">t0</span><span class="p">)</span>
<span class="cm">/*00076204, 8C6702D0*/</span>   <span class="n">lw</span>          <span class="n">a3</span><span class="p">,</span> <span class="mh">0x02d0</span><span class="p">(</span><span class="n">v1</span><span class="p">)</span>
<span class="cm">/*00076208, 356B0020*/</span>   <span class="n">ori</span>         <span class="n">t3</span><span class="p">,</span> <span class="n">t3</span><span class="p">,</span> <span class="mh">0x0020</span>
<span class="cm">/*0007620C, 3C0C8012*/</span>   <span class="n">lui</span>         <span class="n">t4</span><span class="p">,</span> <span class="mh">0x8012</span>
<span class="cm">/*00076210, 24F90008*/</span>   <span class="n">addiu</span>       <span class="n">t9</span><span class="p">,</span> <span class="n">a3</span><span class="p">,</span> <span class="mh">0x0008</span>
<span class="cm">/*00076214, AC7902D0*/</span>   <span class="n">sw</span>          <span class="n">t9</span><span class="p">,</span> <span class="mh">0x02d0</span><span class="p">(</span><span class="n">v1</span><span class="p">)</span>
<span class="cm">/*00076218, ACEB0000*/</span>   <span class="n">sw</span>          <span class="n">t3</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">(</span><span class="n">a3</span><span class="p">)</span>
<span class="cm">/*0007621C, 8D8CA5E0*/</span>   <span class="n">lw</span>          <span class="n">t4</span><span class="p">,</span> <span class="mh">0xa5e0</span><span class="p">(</span><span class="n">t4</span><span class="p">)</span>
<span class="cm">/*00076220, 3C098010*/</span>   <span class="n">lui</span>         <span class="n">t1</span><span class="p">,</span> <span class="mh">0x8010</span>
<span class="cm">/*00076224, 3C0B8012*/</span>   <span class="n">lui</span>         <span class="n">t3</span><span class="p">,</span> <span class="mh">0x8012</span>
<span class="cm">/*00076228, 000C6880*/</span>   <span class="n">sll</span>         <span class="n">t5</span><span class="p">,</span> <span class="n">t4</span><span class="p">,</span> <span class="mh">0x0002</span>
<span class="cm">/*0007622C, 012D4821*/</span>   <span class="n">addu</span>        <span class="n">t1</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t5</span>
<span class="cm">/*00076230, 8D29BE6C*/</span>   <span class="n">lw</span>          <span class="n">t1</span><span class="p">,</span> <span class="mh">0xbe6c</span><span class="p">(</span><span class="n">t1</span><span class="p">)</span>
<span class="cm">/*00076234, 3C0100FF*/</span>   <span class="n">lui</span>         <span class="n">at</span><span class="p">,</span> <span class="mh">0x00ff</span>
<span class="cm">/*00076238, 3421FFFF*/</span>   <span class="n">ori</span>         <span class="n">at</span><span class="p">,</span> <span class="n">at</span><span class="p">,</span> <span class="mh">0xffff</span>
<span class="cm">/*0007623C, 0009C100*/</span>   <span class="n">sll</span>         <span class="n">t8</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="mh">0x0004</span>
<span class="cm">/*00076240, 00187F02*/</span>   <span class="n">srl</span>         <span class="n">t7</span><span class="p">,</span> <span class="n">t8</span><span class="p">,</span> <span class="mh">0x001c</span>
<span class="cm">/*00076244, 000FC880*/</span>   <span class="n">sll</span>         <span class="n">t9</span><span class="p">,</span> <span class="n">t7</span><span class="p">,</span> <span class="mh">0x0002</span>
<span class="cm">/*00076248, 01795821*/</span>   <span class="n">addu</span>        <span class="n">t3</span><span class="p">,</span> <span class="n">t3</span><span class="p">,</span> <span class="n">t9</span>
<span class="cm">/*0007624C, 8D6B0C38*/</span>   <span class="n">lw</span>          <span class="n">t3</span><span class="p">,</span> <span class="mh">0x0c38</span><span class="p">(</span><span class="n">t3</span><span class="p">)</span>
<span class="cm">/*00076250, 01217024*/</span>   <span class="n">and</span>         <span class="n">t6</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">at</span>
<span class="cm">/*00076254, 3C018000*/</span>   <span class="n">lui</span>         <span class="n">at</span><span class="p">,</span> <span class="mh">0x8000</span>
<span class="cm">/*00076258, 01CB6021*/</span>   <span class="n">addu</span>        <span class="n">t4</span><span class="p">,</span> <span class="n">t6</span><span class="p">,</span> <span class="n">t3</span>
<span class="cm">/*0007625C, 01816821*/</span>   <span class="n">addu</span>        <span class="n">t5</span><span class="p">,</span> <span class="n">t4</span><span class="p">,</span> <span class="n">at</span>
<span class="cm">/*00076260, ACED0004*/</span>   <span class="n">sw</span>          <span class="n">t5</span><span class="p">,</span> <span class="mh">0x0004</span><span class="p">(</span><span class="n">a3</span><span class="p">)</span>
<span class="cm">/*00076264, 8FBF0034*/</span>   <span class="n">lw</span>          <span class="n">ra</span><span class="p">,</span> <span class="mh">0x0034</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
<span class="cm">/*00076268, 27BD0050*/</span>   <span class="n">addiu</span>       <span class="n">sp</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="mh">0x0050</span>
<span class="cm">/*0007626C, 03E00008*/</span>   <span class="n">jr</span>          <span class="n">ra</span>
<span class="cm">/*00076270, 00000000*/</span>   <span class="n">nop</span>
</code></pre></div><h2 id="assembling">Assembling</h2>
<p>Now that disassembly works, it&rsquo;s time to do the opposite. I want my program to be able to reassemble what it disassembles. You will know it&rsquo;s working properly when the assembled bytecode matches the original test file.</p>
<p>The same table describing how to disassemble each instruction also says how to reassemble it. As with disassembly, only a handful of functions are involved in assembly.</p>
<p>The basic tokenization functions provided by the C standard library made this super easy.</p>
<div class="highlight"><pre class="chroma"><code class="language-c" data-lang="c"><span class="cp">#define DELIM           &#34; \r\n\t(),=&#34;
</span><span class="cp">#define TOK             strtok(0, DELIM)
</span><span class="cp">#define STREQ(S0, S1)   (!strcasecmp(S0, S1))
</span><span class="cp"></span>
<span class="k">const</span> <span class="k">struct</span> <span class="n">inst</span> <span class="o">*</span><span class="nf">findinstFromString</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
   <span class="k">const</span> <span class="k">struct</span> <span class="n">inst</span> <span class="o">*</span><span class="n">i</span><span class="p">;</span>
   <span class="k">const</span> <span class="k">struct</span> <span class="n">inst</span> <span class="o">*</span><span class="n">end</span> <span class="o">=</span> <span class="n">inst</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">inst</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">inst</span><span class="p">);</span>
   
   <span class="cm">/* search instruction lut for matching name */</span>
   <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">inst</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
      <span class="cm">/* name matches */</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
         <span class="k">return</span> <span class="n">i</span><span class="p">;</span>
   
   <span class="cm">/* no match found */</span>
   <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* given a token, return a register number */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">reg</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">tok</span><span class="p">)</span>
<span class="p">{</span>
   <span class="kt">unsigned</span> <span class="n">i</span><span class="p">;</span>
   <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">lut</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
      <span class="cp">#include</span> <span class="cpf">&#34;reg.h&#34;</span><span class="cp">
</span><span class="cp"></span>   <span class="p">};</span>
   
   <span class="cm">/* skip $ if there is one */</span>
   <span class="n">tok</span> <span class="o">+=</span> <span class="o">*</span><span class="n">tok</span> <span class="o">==</span> <span class="sc">&#39;$&#39;</span><span class="p">;</span>
   
   <span class="cm">/* floating point register */</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">tolower</span><span class="p">(</span><span class="o">*</span><span class="n">tok</span><span class="p">)</span> <span class="o">==</span> <span class="sc">&#39;f&#39;</span><span class="p">)</span>
   <span class="p">{</span>
      <span class="cm">/* if followed immediately by a number less than 32 */</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">sscanf</span><span class="p">(</span><span class="n">tok</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&#34;%d&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">)</span>
         <span class="k">return</span> <span class="n">i</span><span class="p">;</span>
   <span class="p">}</span>
   
   <span class="cm">/* search register lut for matching name */</span>
   <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">lut</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">lut</span><span class="p">);</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">STREQ</span><span class="p">(</span><span class="n">lut</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">tok</span><span class="p">))</span>
         <span class="k">return</span> <span class="n">i</span><span class="p">;</span>
   
   <span class="cm">/* failed to locate register */</span>
   <span class="n">die</span><span class="p">(</span><span class="s">&#34;invalid register &#39;%s&#39;&#34;</span><span class="p">,</span> <span class="n">tok</span><span class="p">);</span>
   <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* generate an instruction */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">inst</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">opname</span><span class="p">)</span>
<span class="p">{</span>
   <span class="k">const</span> <span class="k">struct</span> <span class="n">inst</span> <span class="o">*</span><span class="n">i</span><span class="p">;</span>
   <span class="k">const</span> <span class="k">struct</span> <span class="n">pack</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
   <span class="k">static</span> <span class="kt">int</span> <span class="n">ofs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
   
   <span class="cm">/* no match found */</span>
   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">findinstFromString</span><span class="p">(</span><span class="n">opname</span><span class="p">)))</span>
      <span class="n">die</span><span class="p">(</span><span class="s">&#34;invalid instruction &#39;%s&#39;&#34;</span><span class="p">,</span> <span class="n">opname</span><span class="p">);</span>
   
   <span class="o">++</span><span class="n">ofs</span><span class="p">;</span>
   
   <span class="cm">/* construct result */</span>
   <span class="k">for</span> <span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">i</span><span class="o">-&gt;</span><span class="n">pack</span><span class="p">;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">and</span><span class="p">;</span> <span class="o">++</span><span class="n">p</span><span class="p">)</span>
   <span class="p">{</span>
      <span class="kt">int</span> <span class="n">v</span><span class="p">;</span>
      
      <span class="cm">/* is register */</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">is_reg</span><span class="p">)</span>
         <span class="n">v</span> <span class="o">=</span> <span class="n">reg</span><span class="p">(</span><span class="n">TOK</span><span class="p">);</span>
      
      <span class="cm">/* is value */</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">is_v</span><span class="p">)</span>
         <span class="n">v</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">;</span>
      
      <span class="cm">/* is immediate */</span>
      <span class="k">else</span>
      <span class="p">{</span>
         <span class="n">v</span> <span class="o">=</span> <span class="n">getval</span><span class="p">(</span><span class="n">TOK</span><span class="p">);</span>
      
         <span class="cm">/* if branch, make v relative to ofs */</span>
         <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">is_branch</span> <span class="o">&amp;&amp;</span> <span class="n">g_was_label</span><span class="p">)</span>
            <span class="n">v</span> <span class="o">-=</span> <span class="n">ofs</span><span class="p">;</span>
      <span class="p">}</span>
      
      <span class="cm">/* transform */</span>
      <span class="n">v</span> <span class="o">&amp;=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">and</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">shift</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
         <span class="n">v</span> <span class="o">&lt;&lt;=</span> <span class="o">-</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">shift</span><span class="p">;</span>
      <span class="k">else</span>
         <span class="n">v</span> <span class="o">&gt;&gt;=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">shift</span><span class="p">;</span>
      
      <span class="cm">/* apply */</span>
      <span class="n">result</span> <span class="o">|=</span> <span class="n">v</span><span class="p">;</span>
   <span class="p">}</span>
   
   <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div><p>Assemblers often support commands for applying patches and importing binary data. In the same spirit as the rest of the program, I kept the few I added as simple and unintrusive as possible. They are implemented like so:</p>
<div class="highlight"><pre class="chroma"><code class="language-c" data-lang="c">   <span class="cm">/* handle directives */</span>
   <span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">opname</span> <span class="o">==</span> <span class="sc">&#39;&gt;&#39;</span><span class="p">)</span>
   <span class="p">{</span>
      <span class="kt">char</span> <span class="o">*</span><span class="n">d</span> <span class="o">=</span> <span class="n">TOK</span><span class="p">;</span>
      
      <span class="k">if</span> <span class="p">(</span><span class="n">STREQ</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="s">&#34;seek&#34;</span><span class="p">))</span>
         <span class="n">seek</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">getval</span><span class="p">(</span><span class="n">TOK</span><span class="p">));</span>
      <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">STREQ</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="s">&#34;define&#34;</span><span class="p">))</span>
         <span class="n">define</span><span class="p">();</span>
      <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">STREQ</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="s">&#34;import&#34;</span><span class="p">))</span>
         <span class="n">import</span><span class="p">();</span>
      <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">STREQ</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="s">&#34;incbin&#34;</span><span class="p">))</span>
         <span class="n">incbin</span><span class="p">(</span><span class="n">put</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
      <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">STREQ</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="s">&#34;write32&#34;</span><span class="p">))</span>
         <span class="n">put</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">getval</span><span class="p">(</span><span class="n">TOK</span><span class="p">));</span>
      <span class="k">else</span>
         <span class="nf">die</span><span class="p">(</span><span class="s">&#34;unknown directive &#39;%s&#39;&#34;</span><span class="p">,</span> <span class="n">d</span><span class="p">);</span>
      
      <span class="n">opname</span> <span class="o">=</span> <span class="n">TOK</span><span class="p">;</span>
      
      <span class="cm">/* file ended with a directive */</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">opname</span><span class="p">)</span>
         <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
   <span class="p">}</span>
</code></pre></div><h2 id="compiling-a-rudimentary-hack">Compiling a rudimentary hack</h2>
<p>The last thing I did was write an old fashioned assembly hack for The Legend of Zelda: Ocarina of Time.</p>
<div class="highlight"><pre class="chroma"><code class="language-c" data-lang="c"><span class="cm">/* kokiri-tunic.asm
</span><span class="cm"> * a simple assembly hack for OoT MQ debug using minimips64
</span><span class="cm"> * this one gradually changes the color of the Kokiri Tunic
</span><span class="cm"> */</span>

<span class="cm">/* define some addresses for later use */</span>
<span class="o">&gt;</span> <span class="n">define</span> <span class="n">kRed</span>     <span class="mh">0x80126008</span> <span class="cm">/* Kokiri Tunic RGB color channels */</span>
<span class="o">&gt;</span> <span class="n">define</span> <span class="n">kGreen</span>   <span class="mh">0x80126009</span>
<span class="o">&gt;</span> <span class="n">define</span> <span class="n">kBlue</span>    <span class="mh">0x8012600A</span>
<span class="o">&gt;</span> <span class="n">define</span> <span class="n">GameTime</span> <span class="mh">0x80223E04</span> <span class="cm">/* number of gameplay frames elapsed */</span>

<span class="cm">/* the hack overwrites an unused skelanime function
</span><span class="cm"> * https://github.com/zeldaret/oot/blob/master/src/code/z_skelanime.c
</span><span class="cm"> */</span>
<span class="o">&gt;</span> <span class="n">seek</span> <span class="mh">0xB1C630</span>
<span class="o">&gt;</span> <span class="n">define</span> <span class="n">SkelAnime_CopyFrameTableFalse</span> <span class="mh">0x800A5490</span>
   <span class="n">lui</span>     <span class="n">v0</span><span class="p">,</span> <span class="o">%</span><span class="n">hi</span><span class="p">(</span><span class="n">GameTime</span><span class="p">)</span>
   <span class="n">lw</span>      <span class="n">v0</span><span class="p">,</span> <span class="o">%</span><span class="n">lo</span><span class="p">(</span><span class="n">GameTime</span><span class="p">)(</span><span class="n">v0</span><span class="p">)</span>   <span class="c1">// v0 = time elapsed
</span><span class="c1"></span>   <span class="n">sll</span>     <span class="n">t0</span><span class="p">,</span> <span class="n">v0</span><span class="p">,</span> <span class="mi">2</span>               <span class="c1">// t0 = time * 4
</span><span class="c1"></span>   <span class="n">sll</span>     <span class="n">t1</span><span class="p">,</span> <span class="n">v0</span><span class="p">,</span> <span class="mi">1</span>               <span class="c1">// t1 = time * 2
</span><span class="c1"></span>   <span class="n">lui</span>     <span class="n">v1</span><span class="p">,</span> <span class="o">%</span><span class="n">hi</span><span class="p">(</span><span class="n">kRed</span><span class="p">)</span>
   <span class="n">sb</span>      <span class="n">v0</span><span class="p">,</span> <span class="o">%</span><span class="n">lo</span><span class="p">(</span><span class="n">kRed</span><span class="p">)(</span><span class="n">v1</span><span class="p">)</span>       <span class="c1">// red = time
</span><span class="c1"></span>   <span class="n">sb</span>      <span class="n">t0</span><span class="p">,</span> <span class="o">%</span><span class="n">lo</span><span class="p">(</span><span class="n">kGreen</span><span class="p">)(</span><span class="n">v1</span><span class="p">)</span>     <span class="c1">// green = time * 4
</span><span class="c1"></span>   <span class="n">sb</span>      <span class="n">t1</span><span class="p">,</span> <span class="o">%</span><span class="n">lo</span><span class="p">(</span><span class="n">kBlue</span><span class="p">)(</span><span class="n">v1</span><span class="p">)</span>      <span class="c1">// blue = time * 2
</span><span class="c1"></span>   <span class="n">jr</span>      <span class="n">ra</span>
   <span class="n">nop</span>

<span class="cm">/* we will use this hook */</span>
<span class="o">&gt;</span> <span class="n">seek</span> <span class="mh">0xB3B8A8</span>
   <span class="n">jal</span>     <span class="n">SkelAnime_CopyFrameTableFalse</span>
   <span class="n">nop</span>
</code></pre></div><p>I assemble it and patch it into the game with the following command:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">minimips64 --assemble --rom &#34;oot-debug.z64&#34; &#34;kokiri-tunic.asm&#34;
</code></pre></div><p>And it works as expected!</p>
<p><img src="/images/writing-minimips64-2.gif" alt="image"></p>
<h2 id="the-end">The end</h2>
<p>That&rsquo;s everything. Want to try it out or poke through the code? <a href="https://github.com/z64me/minimips64">It&rsquo;s available on GitHub: z64me/minimips64</a></p></div>
        <div class="post-footer">
            <div class="info">
                
                <span class="separator"><a class="tag" href="/tags/fun/">fun</a><a class="tag" href="/tags/articles/">articles</a><a class="tag" href="/tags/mods/">mods</a></span>
            </div>
        </div>

        
    </div>


            </div>
        </div>
    </main>
</div><footer class="footer footer--base">        
    <div class="by_farbox">
        <ul class="footer__list">
            <li class="footer__item">&copy;
                
                    2018 - 2021
                
            </li>
            
            <li class="footer__item">
                <a href="https://old.z64.me/"  target="_blank" rel="noopener noreferrer"  title="">
                    old site
                </a>
            </li>
            
            <li class="footer__item">
                <a href="/post/index.xml"  title="">
                    rss
                </a>
            </li>
            
        </ul>
    </div>
</footer>

<script type="text/javascript"
        src="/js/medium-zoom.min.83cb1dd5fea8d42d87d1e601a07faa73089ad0ef9ccfe5daf6041289ebcc4e46.js"
        integrity="sha256-g8sd1f6o1C2H0eYBoH&#43;qcwia0O&#43;cz&#43;Xa9gQSievMTkY="
        crossorigin="anonymous"></script></body>

</html>
